<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Dependency-Check Command Line</a> &gt; <a href="index.source.html" class="el_package">org.owasp.dependencycheck</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">/*
 * This file is part of dependency-check-cli.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Copyright (c) 2012 Jeremy Long. All Rights Reserved.
 */
package org.owasp.dependencycheck;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import java.util.stream.Collectors;
import java.util.stream.Stream;
import org.apache.commons.cli.ParseException;
import org.apache.tools.ant.DirectoryScanner;
import org.owasp.dependencycheck.data.nvdcve.DatabaseException;
import org.owasp.dependencycheck.dependency.Dependency;
import org.owasp.dependencycheck.dependency.Vulnerability;
import org.apache.tools.ant.types.LogLevel;
import org.owasp.dependencycheck.data.update.exception.UpdateException;
import org.owasp.dependencycheck.dependency.naming.Identifier;
import org.owasp.dependencycheck.exception.ExceptionCollection;
import org.owasp.dependencycheck.exception.ReportException;
import org.owasp.dependencycheck.utils.Downloader;
import org.owasp.dependencycheck.utils.InvalidSettingException;
import org.owasp.dependencycheck.utils.Settings;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import ch.qos.logback.core.FileAppender;
import ch.qos.logback.classic.encoder.PatternLayoutEncoder;
import ch.qos.logback.classic.filter.ThresholdFilter;
import ch.qos.logback.classic.spi.ILoggingEvent;
import ch.qos.logback.classic.Level;
import ch.qos.logback.classic.LoggerContext;
import io.github.jeremylong.jcs3.slf4j.Slf4jAdapter;
import java.util.TreeSet;
import org.owasp.dependencycheck.utils.SeverityUtil;

/**
 * The command line interface for the DependencyCheck application.
 *
 * @author Jeremy Long
 */
@SuppressWarnings(&quot;squid:S106&quot;)
public class App {

    /**
     * The logger.
     */
<span class="fc" id="L66">    private static final Logger LOGGER = LoggerFactory.getLogger(App.class);</span>
    /**
     * Properties file error message.
     */
    private static final String ERROR_LOADING_PROPERTIES_FILE = &quot;Error loading properties file&quot;;
    /**
     * System specific new line character.
     */
<span class="fc" id="L74">    private static final String NEW_LINE = System.getProperty(&quot;line.separator&quot;, &quot;\n&quot;);</span>
    /**
     * The configured settings.
     */
    private final Settings settings;

    /**
     * The main method for the application.
     *
     * @param args the command line arguments
     */
    @SuppressWarnings(&quot;squid:S4823&quot;)
    public static void main(String[] args) {
<span class="nc" id="L87">        System.setProperty(&quot;jcs.logSystem&quot;, &quot;slf4j&quot;);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (!LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L89">            Slf4jAdapter.muteLogging(true);</span>
        }
        final int exitCode;
<span class="nc" id="L92">        final App app = new App();</span>
<span class="nc" id="L93">        exitCode = app.run(args);</span>
<span class="nc" id="L94">        LOGGER.debug(&quot;Exit code: {}&quot;, exitCode);</span>
<span class="nc" id="L95">        System.exit(exitCode);</span>
<span class="nc" id="L96">    }</span>

    /**
     * Builds the App object.
     */
<span class="nc" id="L101">    public App() {</span>
<span class="nc" id="L102">        settings = new Settings();</span>
<span class="nc" id="L103">    }</span>

    /**
     * Builds the App object; this method is used for testing.
     *
     * @param settings the configured settings
     */
<span class="fc" id="L110">    protected App(Settings settings) {</span>
<span class="fc" id="L111">        this.settings = settings;</span>
<span class="fc" id="L112">    }</span>

    /**
     * Main CLI entry-point into the application.
     *
     * @param args the command line arguments
     * @return the exit code to return
     */
    public int run(String[] args) {
<span class="nc" id="L121">        int exitCode = 0;</span>
<span class="nc" id="L122">        final CliParser cli = new CliParser(settings);</span>

        try {
<span class="nc" id="L125">            cli.parse(args);</span>
<span class="nc" id="L126">        } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L127">            System.err.println(ex.getMessage());</span>
<span class="nc" id="L128">            cli.printHelp();</span>
<span class="nc" id="L129">            return 1;</span>
<span class="nc" id="L130">        } catch (ParseException ex) {</span>
<span class="nc" id="L131">            System.err.println(ex.getMessage());</span>
<span class="nc" id="L132">            cli.printHelp();</span>
<span class="nc" id="L133">            return 2;</span>
<span class="nc" id="L134">        }</span>
<span class="nc" id="L135">        final String verboseLog = cli.getStringArgument(CliParser.ARGUMENT.VERBOSE_LOG);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (verboseLog != null) {</span>
<span class="nc" id="L137">            prepareLogger(verboseLog);</span>
        }

<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (cli.isPurge()) {</span>
<span class="nc" id="L141">            final String connStr = cli.getStringArgument(CliParser.ARGUMENT.CONNECTION_STRING);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (connStr != null) {</span>
<span class="nc" id="L143">                LOGGER.error(&quot;Unable to purge the database when using a non-default connection string&quot;);</span>
<span class="nc" id="L144">                exitCode = 3;</span>
            } else {
                try {
<span class="nc" id="L147">                    populateSettings(cli);</span>
<span class="nc" id="L148">                    Downloader.getInstance().configure(settings);</span>
<span class="nc" id="L149">                } catch (InvalidSettingException ex) {</span>
<span class="nc" id="L150">                    LOGGER.error(ex.getMessage());</span>
<span class="nc" id="L151">                    LOGGER.debug(ERROR_LOADING_PROPERTIES_FILE, ex);</span>
<span class="nc" id="L152">                    exitCode = 4;</span>
<span class="nc" id="L153">                    return exitCode;</span>
<span class="nc" id="L154">                }</span>
<span class="nc" id="L155">                try (Engine engine = new Engine(Engine.Mode.EVIDENCE_PROCESSING, settings)) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                    if (!engine.purge()) {</span>
<span class="nc" id="L157">                        exitCode = 7;</span>
<span class="nc" id="L158">                        return exitCode;</span>
                    }
<span class="nc" id="L160">                } finally {</span>
<span class="nc" id="L161">                    settings.cleanup();</span>
                }
            }
<span class="nc bnc" id="L164" title="All 2 branches missed.">        } else if (cli.isGetVersion()) {</span>
<span class="nc" id="L165">            cli.printVersionInfo();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        } else if (cli.isUpdateOnly()) {</span>
            try {
<span class="nc" id="L168">                populateSettings(cli);</span>
<span class="nc" id="L169">                settings.setBoolean(Settings.KEYS.AUTO_UPDATE, true);</span>
<span class="nc" id="L170">                Downloader.getInstance().configure(settings);</span>
<span class="nc" id="L171">            } catch (InvalidSettingException ex) {</span>
<span class="nc" id="L172">                LOGGER.error(ex.getMessage());</span>
<span class="nc" id="L173">                LOGGER.debug(ERROR_LOADING_PROPERTIES_FILE, ex);</span>
<span class="nc" id="L174">                exitCode = 4;</span>
<span class="nc" id="L175">                return exitCode;</span>
<span class="nc" id="L176">            }</span>
            try {
<span class="nc" id="L178">                runUpdateOnly();</span>
<span class="nc" id="L179">            } catch (UpdateException ex) {</span>
<span class="nc" id="L180">                LOGGER.error(ex.getMessage(), ex);</span>
<span class="nc" id="L181">                exitCode = 8;</span>
<span class="nc" id="L182">            } catch (DatabaseException ex) {</span>
<span class="nc" id="L183">                LOGGER.error(ex.getMessage(), ex);</span>
<span class="nc" id="L184">                exitCode = 9;</span>
            } finally {
<span class="nc" id="L186">                settings.cleanup();</span>
<span class="nc" id="L187">            }</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        } else if (cli.isRunScan()) {</span>
            try {
<span class="nc" id="L190">                populateSettings(cli);</span>
<span class="nc" id="L191">                Downloader.getInstance().configure(settings);</span>
<span class="nc" id="L192">            } catch (InvalidSettingException ex) {</span>
<span class="nc" id="L193">                LOGGER.error(ex.getMessage(), ex);</span>
<span class="nc" id="L194">                LOGGER.debug(ERROR_LOADING_PROPERTIES_FILE, ex);</span>
<span class="nc" id="L195">                exitCode = 4;</span>
<span class="nc" id="L196">                return exitCode;</span>
<span class="nc" id="L197">            }</span>
            try {
<span class="nc" id="L199">                final String[] scanFiles = cli.getScanFiles();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                if (scanFiles != null) {</span>
<span class="nc" id="L201">                    exitCode = runScan(cli.getReportDirectory(), cli.getReportFormat(), cli.getProjectName(), scanFiles,</span>
<span class="nc" id="L202">                            cli.getExcludeList(), cli.getSymLinkDepth(), cli.getFailOnCVSS());</span>
                } else {
<span class="nc" id="L204">                    LOGGER.error(&quot;No scan files configured&quot;);</span>
                }
<span class="nc" id="L206">            } catch (DatabaseException ex) {</span>
<span class="nc" id="L207">                LOGGER.error(ex.getMessage());</span>
<span class="nc" id="L208">                LOGGER.debug(&quot;database exception&quot;, ex);</span>
<span class="nc" id="L209">                exitCode = 11;</span>
<span class="nc" id="L210">            } catch (ReportException ex) {</span>
<span class="nc" id="L211">                LOGGER.error(ex.getMessage());</span>
<span class="nc" id="L212">                LOGGER.debug(&quot;report exception&quot;, ex);</span>
<span class="nc" id="L213">                exitCode = 12;</span>
<span class="nc" id="L214">            } catch (ExceptionCollection ex) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                if (ex.isFatal()) {</span>
<span class="nc" id="L216">                    exitCode = 13;</span>
<span class="nc" id="L217">                    LOGGER.error(&quot;One or more fatal errors occurred&quot;);</span>
                } else {
<span class="nc" id="L219">                    exitCode = 14;</span>
                }
<span class="nc bnc" id="L221" title="All 2 branches missed.">                for (Throwable e : ex.getExceptions()) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (e.getMessage() != null) {</span>
<span class="nc" id="L223">                        LOGGER.error(e.getMessage());</span>
<span class="nc" id="L224">                        LOGGER.debug(&quot;unexpected error&quot;, e);</span>
                    }
<span class="nc" id="L226">                }</span>
            } finally {
<span class="nc" id="L228">                settings.cleanup();</span>
<span class="nc" id="L229">            }</span>
        } else {
<span class="nc" id="L231">            cli.printHelp();</span>
        }
<span class="nc" id="L233">        return exitCode;</span>
    }

    /**
     * Scans the specified directories and writes the dependency reports to the
     * reportDirectory.
     *
     * @param reportDirectory the path to the directory where the reports will
     * be written
     * @param outputFormats String[] of output formats of the report
     * @param applicationName the application name for the report
     * @param files the files/directories to scan
     * @param excludes the patterns for files/directories to exclude
     * @param symLinkDepth the depth that symbolic links will be followed
     * @param cvssFailScore the score to fail on if a vulnerability is found
     * @return the exit code if there was an error
     * @throws ReportException thrown when the report cannot be generated
     * @throws DatabaseException thrown when there is an error connecting to the
     * database
     * @throws ExceptionCollection thrown when an exception occurs during
     * analysis; there may be multiple exceptions contained within the
     * collection.
     */
    private int runScan(String reportDirectory, String[] outputFormats, String applicationName, String[] files,
            String[] excludes, int symLinkDepth, float cvssFailScore) throws DatabaseException,
            ExceptionCollection, ReportException {
<span class="nc" id="L259">        Engine engine = null;</span>
        try {
<span class="nc" id="L261">            final List&lt;String&gt; antStylePaths = getPaths(files);</span>
<span class="nc" id="L262">            final Set&lt;File&gt; paths = scanAntStylePaths(antStylePaths, symLinkDepth, excludes);</span>

<span class="nc" id="L264">            engine = new Engine(settings);</span>
<span class="nc" id="L265">            engine.scan(paths);</span>

<span class="nc" id="L267">            ExceptionCollection exCol = null;</span>
            try {
<span class="nc" id="L269">                engine.analyzeDependencies();</span>
<span class="nc" id="L270">            } catch (ExceptionCollection ex) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                if (ex.isFatal()) {</span>
<span class="nc" id="L272">                    throw ex;</span>
                }
<span class="nc" id="L274">                exCol = ex;</span>
<span class="nc" id="L275">            }</span>

            try {
<span class="nc bnc" id="L278" title="All 2 branches missed.">                for (String outputFormat : outputFormats) {</span>
<span class="nc" id="L279">                    engine.writeReports(applicationName, new File(reportDirectory), outputFormat, exCol);</span>
                }
<span class="nc" id="L281">            } catch (ReportException ex) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                if (exCol != null) {</span>
<span class="nc" id="L283">                    exCol.addException(ex);</span>
<span class="nc" id="L284">                    throw exCol;</span>
                } else {
<span class="nc" id="L286">                    throw ex;</span>
                }
<span class="nc" id="L288">            }</span>
<span class="nc bnc" id="L289" title="All 4 branches missed.">            if (exCol != null &amp;&amp; !exCol.getExceptions().isEmpty()) {</span>
<span class="nc" id="L290">                throw exCol;</span>
            }
<span class="nc" id="L292">            return determineReturnCode(engine, cvssFailScore);</span>
        } finally {
<span class="nc bnc" id="L294" title="All 2 branches missed.">            if (engine != null) {</span>
<span class="nc" id="L295">                engine.close();</span>
            }
        }
    }

    /**
     * Determines the return code based on if one of the dependencies scanned
     * has a vulnerability with a CVSS score above the cvssFailScore.
     *
     * @param engine the engine used during analysis
     * @param cvssFailScore the max allowed CVSS score
     * @return returns &lt;code&gt;1&lt;/code&gt; if a severe enough vulnerability is
     * identified; otherwise &lt;code&gt;0&lt;/code&gt;
     */
    private int determineReturnCode(Engine engine, float cvssFailScore) {
<span class="nc" id="L310">        int retCode = 0;</span>
        //Set the exit code based on whether we found a high enough vulnerability
<span class="nc" id="L312">        final StringBuilder ids = new StringBuilder();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        for (Dependency d : engine.getDependencies()) {</span>
<span class="nc" id="L314">            boolean addName = true;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            for (Vulnerability v : d.getVulnerabilities()) {</span>
<span class="nc bnc" id="L316" title="All 4 branches missed.">                final double cvssV2 = v.getCvssV2() != null &amp;&amp; v.getCvssV2().getCvssData() != null</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                        &amp;&amp; v.getCvssV2().getCvssData().getBaseScore() != null ? v.getCvssV2().getCvssData().getBaseScore() : -1;</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">                final double cvssV3 = v.getCvssV3() != null &amp;&amp; v.getCvssV3().getCvssData() != null</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                        &amp;&amp; v.getCvssV3().getCvssData().getBaseScore() != null ? v.getCvssV3().getCvssData().getBaseScore() : -1;</span>
<span class="nc bnc" id="L320" title="All 4 branches missed.">                final double cvssV4 = v.getCvssV4() != null &amp;&amp; v.getCvssV4().getCvssData() != null</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                        &amp;&amp; v.getCvssV4().getCvssData().getBaseScore() != null ? v.getCvssV4().getCvssData().getBaseScore() : -1;</span>
<span class="nc bnc" id="L322" title="All 6 branches missed.">                final boolean useUnscored = cvssV2 == -1 &amp;&amp; cvssV3 == -1 &amp;&amp; cvssV4 == -1;</span>
<span class="nc bnc" id="L323" title="All 4 branches missed.">                final double unscoredCvss = (useUnscored &amp;&amp; v.getUnscoredSeverity() != null) ? SeverityUtil.estimateCvssV2(v.getUnscoredSeverity()) : -1;</span>

<span class="nc bnc" id="L325" title="All 10 branches missed.">                if (cvssV2 &gt;= cvssFailScore</span>
                        || cvssV3 &gt;= cvssFailScore
                        || cvssV4 &gt;= cvssFailScore
                        || unscoredCvss &gt;= cvssFailScore
                        //safety net to fail on any if for some reason the above misses on 0
                        || (cvssFailScore &lt;= 0.0f)) {
<span class="nc" id="L331">                    double score = 0.0;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                    if (cvssV4 &gt;= 0.0) {</span>
<span class="nc" id="L333">                        score = cvssV4;</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                    } else if (cvssV3 &gt;= 0.0) {</span>
<span class="nc" id="L335">                        score = cvssV3;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                    } else if (cvssV2 &gt;= 0.0) {</span>
<span class="nc" id="L337">                        score = cvssV2;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                    } else if (unscoredCvss &gt;= 0.0) {</span>
<span class="nc" id="L339">                        score = unscoredCvss;</span>
                    }
<span class="nc bnc" id="L341" title="All 2 branches missed.">                    if (addName) {</span>
<span class="nc" id="L342">                        addName = false;</span>
<span class="nc" id="L343">                        ids.append(NEW_LINE).append(d.getFileName()).append(&quot; (&quot;)</span>
<span class="nc" id="L344">                           .append(Stream.concat(d.getSoftwareIdentifiers().stream(), d.getVulnerableSoftwareIdentifiers().stream())</span>
<span class="nc" id="L345">                                         .map(Identifier::getValue)</span>
<span class="nc" id="L346">                                         .collect(Collectors.joining(&quot;, &quot;)))</span>
<span class="nc" id="L347">                           .append(&quot;): &quot;);</span>
<span class="nc" id="L348">                        ids.append(v.getName()).append('(').append(score).append(')');</span>
                    } else {
<span class="nc" id="L350">                        ids.append(&quot;, &quot;).append(v.getName()).append('(').append(score).append(')');</span>
                    }
                }
<span class="nc" id="L353">            }</span>
        }
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (ids.length() &gt; 0) {</span>
<span class="nc" id="L356">            LOGGER.error(</span>
<span class="nc" id="L357">                    String.format(&quot;%n%nOne or more dependencies were identified with vulnerabilities that have a CVSS score greater than or &quot;</span>
<span class="nc" id="L358">                            + &quot;equal to '%.1f': %n%s%n%nSee the dependency-check report for more details.%n%n&quot;, cvssFailScore, ids)</span>
            );

<span class="nc" id="L361">            retCode = 15;</span>
        }

<span class="nc" id="L364">        return retCode;</span>
    }

    /**
     * Scans the give Ant Style paths and collects the actual files.
     *
     * @param antStylePaths a list of ant style paths to scan for actual files
     * @param symLinkDepth the depth to traverse symbolic links
     * @param excludes an array of ant style excludes
     * @return returns the set of identified files
     */
    private Set&lt;File&gt; scanAntStylePaths(List&lt;String&gt; antStylePaths, int symLinkDepth, String[] excludes) {
<span class="nc" id="L376">        final Set&lt;File&gt; paths = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        for (String file : antStylePaths) {</span>
<span class="nc" id="L378">            LOGGER.debug(&quot;Scanning {}&quot;, file);</span>
<span class="nc" id="L379">            final DirectoryScanner scanner = new DirectoryScanner();</span>
<span class="nc" id="L380">            String include = file.replace('\\', '/');</span>
            final File baseDir;
<span class="nc" id="L382">            final int pos = getLastFileSeparator(include);</span>
<span class="nc" id="L383">            String tmpBase = include.substring(0, pos);</span>
            //fix for windows style paths scanning c:/temp.
<span class="nc bnc" id="L385" title="All 2 branches missed.">            if (tmpBase.endsWith(&quot;:&quot;)) {</span>
<span class="nc" id="L386">                tmpBase += &quot;/&quot;;</span>
            }
<span class="nc" id="L388">            final String tmpInclude = include.substring(pos + 1);</span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">            if (tmpInclude.indexOf('*') &gt;= 0 || tmpInclude.indexOf('?') &gt;= 0</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                    || new File(include).isFile()) {</span>
<span class="nc" id="L391">                baseDir = new File(tmpBase);</span>
<span class="nc" id="L392">                include = tmpInclude;</span>
            } else {
<span class="nc" id="L394">                baseDir = new File(tmpBase, tmpInclude);</span>
<span class="nc" id="L395">                include = &quot;**/*&quot;;</span>
            }
<span class="nc" id="L397">            LOGGER.debug(&quot;BaseDir: &quot; + baseDir);</span>
<span class="nc" id="L398">            LOGGER.debug(&quot;Include: &quot; + include);</span>
<span class="nc" id="L399">            scanner.setBasedir(baseDir);</span>
<span class="nc" id="L400">            final String[] includes = {include};</span>
<span class="nc" id="L401">            scanner.setIncludes(includes);</span>
<span class="nc" id="L402">            scanner.setMaxLevelsOfSymlinks(symLinkDepth);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">            if (symLinkDepth &lt;= 0) {</span>
<span class="nc" id="L404">                scanner.setFollowSymlinks(false);</span>
            }
<span class="nc bnc" id="L406" title="All 4 branches missed.">            if (excludes != null &amp;&amp; excludes.length &gt; 0) {</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                for (String e : excludes) {</span>
<span class="nc" id="L408">                    LOGGER.debug(&quot;Exclude: &quot; + e);</span>
                }
<span class="nc" id="L410">                scanner.addExcludes(excludes);</span>
            }
<span class="nc" id="L412">            scanner.scan();</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">            if (scanner.getIncludedFilesCount() &gt; 0) {</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                for (String s : scanner.getIncludedFiles()) {</span>
<span class="nc" id="L415">                    final File f = new File(baseDir, s);</span>
<span class="nc" id="L416">                    LOGGER.debug(&quot;Found file {}&quot;, f);</span>
<span class="nc" id="L417">                    paths.add(f);</span>
                }
            }
<span class="nc" id="L420">        }</span>
<span class="nc" id="L421">        return paths;</span>
    }

    /**
     * Determines the ant style paths from the given array of files.
     *
     * @param files an array of file paths
     * @return a list containing ant style paths
     */
    private List&lt;String&gt; getPaths(String[] files) {
<span class="nc" id="L431">        final List&lt;String&gt; antStylePaths = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (String file : files) {</span>
<span class="nc" id="L433">            final String antPath = ensureCanonicalPath(file);</span>
<span class="nc" id="L434">            antStylePaths.add(antPath);</span>
        }
<span class="nc" id="L436">        return antStylePaths;</span>
    }

    /**
     * Only executes the update phase of dependency-check.
     *
     * @throws UpdateException thrown if there is an error updating
     * @throws DatabaseException thrown if a fatal error occurred and a
     * connection to the database could not be established
     */
    private void runUpdateOnly() throws UpdateException, DatabaseException {
<span class="nc" id="L447">        try (Engine engine = new Engine(settings)) {</span>
<span class="nc" id="L448">            engine.doUpdates();</span>
        }
<span class="nc" id="L450">    }</span>

    //CSOFF: MethodLength
    /**
     * Updates the global Settings.
     *
     * @param cli a reference to the CLI Parser that contains the command line
     * arguments used to set the corresponding settings in the core engine.
     * @throws InvalidSettingException thrown when a user defined properties
     * file is unable to be loaded.
     */
    protected void populateSettings(CliParser cli) throws InvalidSettingException {
<span class="fc" id="L462">        final File propertiesFile = cli.getFileArgument(CliParser.ARGUMENT.PROP);</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">        if (propertiesFile != null) {</span>
            try {
<span class="fc" id="L465">                settings.mergeProperties(propertiesFile);</span>
<span class="nc" id="L466">            } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L467">                throw new InvalidSettingException(&quot;Unable to find properties file '&quot; + propertiesFile.getPath() + &quot;'&quot;, ex);</span>
<span class="nc" id="L468">            } catch (IOException ex) {</span>
<span class="nc" id="L469">                throw new InvalidSettingException(&quot;Error reading properties file '&quot; + propertiesFile.getPath() + &quot;'&quot;, ex);</span>
<span class="fc" id="L470">            }</span>
        }
<span class="fc" id="L472">        final String dataDirectory = cli.getStringArgument(CliParser.ARGUMENT.DATA_DIRECTORY);</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">        if (dataDirectory != null) {</span>
<span class="nc" id="L474">            settings.setString(Settings.KEYS.DATA_DIRECTORY, dataDirectory);</span>
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">        } else if (System.getProperty(&quot;basedir&quot;) != null) {</span>
<span class="fc" id="L476">            final File dataDir = new File(System.getProperty(&quot;basedir&quot;), &quot;data&quot;);</span>
<span class="fc" id="L477">            settings.setString(Settings.KEYS.DATA_DIRECTORY, dataDir.getAbsolutePath());</span>
<span class="fc" id="L478">        } else {</span>
<span class="nc" id="L479">            final File jarPath = new File(App.class</span>
<span class="nc" id="L480">                    .getProtectionDomain().getCodeSource().getLocation().getPath());</span>
<span class="nc" id="L481">            final File base = jarPath.getParentFile();</span>
<span class="nc" id="L482">            final String sub = settings.getString(Settings.KEYS.DATA_DIRECTORY);</span>
<span class="nc" id="L483">            final File dataDir = new File(base, sub);</span>
<span class="nc" id="L484">            settings.setString(Settings.KEYS.DATA_DIRECTORY, dataDir.getAbsolutePath());</span>
        }
<span class="fc bfc" id="L486" title="All 2 branches covered.">        final Boolean autoUpdate = cli.hasOption(CliParser.ARGUMENT.DISABLE_AUTO_UPDATE) != null ? false : null;</span>
<span class="fc" id="L487">        settings.setBooleanIfNotNull(Settings.KEYS.AUTO_UPDATE, autoUpdate);</span>
<span class="fc" id="L488">        settings.setStringIfNotEmpty(Settings.KEYS.PROXY_SERVER,</span>
<span class="fc" id="L489">                cli.getStringArgument(CliParser.ARGUMENT.PROXY_SERVER));</span>
<span class="fc" id="L490">        settings.setStringIfNotEmpty(Settings.KEYS.PROXY_PORT,</span>
<span class="fc" id="L491">                cli.getStringArgument(CliParser.ARGUMENT.PROXY_PORT));</span>
<span class="fc" id="L492">        settings.setStringIfNotEmpty(Settings.KEYS.PROXY_USERNAME,</span>
<span class="fc" id="L493">                cli.getStringArgument(CliParser.ARGUMENT.PROXY_USERNAME));</span>
<span class="fc" id="L494">        settings.setStringIfNotEmpty(Settings.KEYS.PROXY_PASSWORD,</span>
<span class="fc" id="L495">                cli.getStringArgument(CliParser.ARGUMENT.PROXY_PASSWORD, Settings.KEYS.PROXY_PASSWORD));</span>
<span class="fc" id="L496">        settings.setStringIfNotEmpty(Settings.KEYS.PROXY_NON_PROXY_HOSTS,</span>
<span class="fc" id="L497">                cli.getStringArgument(CliParser.ARGUMENT.NON_PROXY_HOSTS));</span>
<span class="fc" id="L498">        settings.setStringIfNotEmpty(Settings.KEYS.CONNECTION_TIMEOUT,</span>
<span class="fc" id="L499">                cli.getStringArgument(CliParser.ARGUMENT.CONNECTION_TIMEOUT));</span>
<span class="fc" id="L500">        settings.setStringIfNotEmpty(Settings.KEYS.CONNECTION_READ_TIMEOUT,</span>
<span class="fc" id="L501">                cli.getStringArgument(CliParser.ARGUMENT.CONNECTION_READ_TIMEOUT));</span>
<span class="fc" id="L502">        settings.setStringIfNotEmpty(Settings.KEYS.HINTS_FILE,</span>
<span class="fc" id="L503">                cli.getStringArgument(CliParser.ARGUMENT.HINTS_FILE));</span>
<span class="fc" id="L504">        settings.setArrayIfNotEmpty(Settings.KEYS.SUPPRESSION_FILE,</span>
<span class="fc" id="L505">                cli.getStringArguments(CliParser.ARGUMENT.SUPPRESSION_FILES));</span>
<span class="fc" id="L506">        settings.setStringIfNotEmpty(Settings.KEYS.SUPPRESSION_FILE_USER,</span>
<span class="fc" id="L507">                cli.getStringArgument(CliParser.ARGUMENT.SUPPRESSION_FILE_USER));</span>
<span class="fc" id="L508">        settings.setStringIfNotEmpty(Settings.KEYS.SUPPRESSION_FILE_PASSWORD,</span>
<span class="fc" id="L509">                cli.getStringArgument(CliParser.ARGUMENT.SUPPRESSION_FILE_PASSWORD));</span>
<span class="fc" id="L510">        settings.setStringIfNotEmpty(Settings.KEYS.SUPPRESSION_FILE_BEARER_TOKEN,</span>
<span class="fc" id="L511">                cli.getStringArgument(CliParser.ARGUMENT.SUPPRESSION_FILE_BEARER_TOKEN));</span>
        //File Type Analyzer Settings
<span class="fc" id="L513">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_EXPERIMENTAL_ENABLED,</span>
<span class="fc" id="L514">                cli.hasOption(CliParser.ARGUMENT.EXPERIMENTAL));</span>
<span class="fc" id="L515">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_RETIRED_ENABLED,</span>
<span class="fc" id="L516">                cli.hasOption(CliParser.ARGUMENT.RETIRED));</span>
<span class="fc" id="L517">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_GOLANG_PATH,</span>
<span class="fc" id="L518">                cli.getStringArgument(CliParser.ARGUMENT.PATH_TO_GO));</span>
<span class="fc" id="L519">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_YARN_PATH,</span>
<span class="fc" id="L520">                cli.getStringArgument(CliParser.ARGUMENT.PATH_TO_YARN));</span>
<span class="fc" id="L521">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_PNPM_PATH,</span>
<span class="fc" id="L522">                cli.getStringArgument(CliParser.ARGUMENT.PATH_TO_PNPM));</span>
<span class="fc" id="L523">        settings.setBooleanIfNotNull(Settings.KEYS.PRETTY_PRINT,</span>
<span class="fc" id="L524">                cli.hasOption(CliParser.ARGUMENT.PRETTY_PRINT));</span>
<span class="fc" id="L525">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_RETIREJS_REPO_JS_URL,</span>
<span class="fc" id="L526">                cli.getStringArgument(CliParser.ARGUMENT.RETIREJS_URL));</span>
<span class="fc" id="L527">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_RETIREJS_REPO_JS_USER,</span>
<span class="fc" id="L528">                cli.getStringArgument(CliParser.ARGUMENT.RETIREJS_URL_USER));</span>
<span class="fc" id="L529">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_RETIREJS_REPO_JS_PASSWORD,</span>
<span class="fc" id="L530">                cli.getStringArgument(CliParser.ARGUMENT.RETIREJS_URL_PASSWORD));</span>
<span class="fc" id="L531">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_RETIREJS_REPO_JS_BEARER_TOKEN,</span>
<span class="fc" id="L532">                cli.getStringArgument(CliParser.ARGUMENT.RETIREJS_URL_BEARER_TOKEN));</span>
<span class="fc" id="L533">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_RETIREJS_FORCEUPDATE,</span>
<span class="fc" id="L534">                cli.hasOption(CliParser.ARGUMENT.RETIRE_JS_FORCEUPDATE));</span>
<span class="fc" id="L535">        settings.setStringIfNotNull(Settings.KEYS.ANALYZER_RETIREJS_FILTERS,</span>
<span class="fc" id="L536">                cli.getStringArgument(CliParser.ARGUMENT.RETIREJS_FILTERS));</span>
<span class="fc" id="L537">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_RETIREJS_FILTER_NON_VULNERABLE,</span>
<span class="fc" id="L538">                cli.hasOption(CliParser.ARGUMENT.RETIREJS_FILTER_NON_VULNERABLE));</span>
<span class="fc" id="L539">        settings.setBoolean(Settings.KEYS.ANALYZER_JAR_ENABLED,</span>
<span class="fc bfc" id="L540" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_JAR, Settings.KEYS.ANALYZER_JAR_ENABLED));</span>
<span class="fc" id="L541">        settings.setBoolean(Settings.KEYS.UPDATE_VERSION_CHECK_ENABLED,</span>
<span class="fc bfc" id="L542" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_VERSION_CHECK, Settings.KEYS.UPDATE_VERSION_CHECK_ENABLED));</span>
<span class="fc" id="L543">        settings.setBoolean(Settings.KEYS.ANALYZER_MSBUILD_PROJECT_ENABLED,</span>
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_MSBUILD, Settings.KEYS.ANALYZER_MSBUILD_PROJECT_ENABLED));</span>
<span class="fc" id="L545">        settings.setBoolean(Settings.KEYS.ANALYZER_ARCHIVE_ENABLED,</span>
<span class="fc bfc" id="L546" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_ARCHIVE, Settings.KEYS.ANALYZER_ARCHIVE_ENABLED));</span>
<span class="fc" id="L547">        settings.setBoolean(Settings.KEYS.ANALYZER_KNOWN_EXPLOITED_ENABLED,</span>
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_KEV, Settings.KEYS.ANALYZER_KNOWN_EXPLOITED_ENABLED));</span>
<span class="fc" id="L549">        settings.setStringIfNotNull(Settings.KEYS.KEV_URL,</span>
<span class="fc" id="L550">                cli.getStringArgument(CliParser.ARGUMENT.KEV_URL));</span>
<span class="fc" id="L551">        settings.setStringIfNotNull(Settings.KEYS.KEV_USER,</span>
<span class="fc" id="L552">                cli.getStringArgument(CliParser.ARGUMENT.KEV_USER));</span>
<span class="fc" id="L553">        settings.setStringIfNotNull(Settings.KEYS.KEV_PASSWORD,</span>
<span class="fc" id="L554">                cli.getStringArgument(CliParser.ARGUMENT.KEV_PASSWORD));</span>
<span class="fc" id="L555">        settings.setStringIfNotNull(Settings.KEYS.KEV_BEARER_TOKEN,</span>
<span class="fc" id="L556">                cli.getStringArgument(CliParser.ARGUMENT.KEV_BEARER_TOKEN));</span>
<span class="fc" id="L557">        settings.setBoolean(Settings.KEYS.ANALYZER_PYTHON_DISTRIBUTION_ENABLED,</span>
<span class="fc bfc" id="L558" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_PY_DIST, Settings.KEYS.ANALYZER_PYTHON_DISTRIBUTION_ENABLED));</span>
<span class="fc" id="L559">        settings.setBoolean(Settings.KEYS.ANALYZER_PYTHON_PACKAGE_ENABLED,</span>
<span class="fc bfc" id="L560" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_PY_PKG, Settings.KEYS.ANALYZER_PYTHON_PACKAGE_ENABLED));</span>
<span class="fc" id="L561">        settings.setBoolean(Settings.KEYS.ANALYZER_AUTOCONF_ENABLED,</span>
<span class="fc bfc" id="L562" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_AUTOCONF, Settings.KEYS.ANALYZER_AUTOCONF_ENABLED));</span>
<span class="fc" id="L563">        settings.setBoolean(Settings.KEYS.ANALYZER_MAVEN_INSTALL_ENABLED,</span>
<span class="fc bfc" id="L564" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_MAVEN_INSTALL, Settings.KEYS.ANALYZER_MAVEN_INSTALL_ENABLED));</span>
<span class="fc" id="L565">        settings.setBoolean(Settings.KEYS.ANALYZER_PIP_ENABLED,</span>
<span class="fc bfc" id="L566" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_PIP, Settings.KEYS.ANALYZER_PIP_ENABLED));</span>
<span class="fc" id="L567">        settings.setBoolean(Settings.KEYS.ANALYZER_PIPFILE_ENABLED,</span>
<span class="fc bfc" id="L568" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_PIPFILE, Settings.KEYS.ANALYZER_PIPFILE_ENABLED));</span>
<span class="fc" id="L569">        settings.setBoolean(Settings.KEYS.ANALYZER_POETRY_ENABLED,</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_POETRY, Settings.KEYS.ANALYZER_POETRY_ENABLED));</span>
<span class="fc" id="L571">        settings.setBoolean(Settings.KEYS.ANALYZER_CMAKE_ENABLED,</span>
<span class="fc bfc" id="L572" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_CMAKE, Settings.KEYS.ANALYZER_CMAKE_ENABLED));</span>
<span class="fc" id="L573">        settings.setBoolean(Settings.KEYS.ANALYZER_NUSPEC_ENABLED,</span>
<span class="fc bfc" id="L574" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_NUSPEC, Settings.KEYS.ANALYZER_NUSPEC_ENABLED));</span>
<span class="fc" id="L575">        settings.setBoolean(Settings.KEYS.ANALYZER_NUGETCONF_ENABLED,</span>
<span class="fc bfc" id="L576" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_NUGETCONF, Settings.KEYS.ANALYZER_NUGETCONF_ENABLED));</span>
<span class="fc" id="L577">        settings.setBoolean(Settings.KEYS.ANALYZER_ASSEMBLY_ENABLED,</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_ASSEMBLY, Settings.KEYS.ANALYZER_ASSEMBLY_ENABLED));</span>
<span class="fc" id="L579">        settings.setBoolean(Settings.KEYS.ANALYZER_BUNDLE_AUDIT_ENABLED,</span>
<span class="pc bpc" id="L580" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_BUNDLE_AUDIT, Settings.KEYS.ANALYZER_BUNDLE_AUDIT_ENABLED));</span>
<span class="fc" id="L581">        settings.setBoolean(Settings.KEYS.ANALYZER_FILE_NAME_ENABLED,</span>
<span class="fc bfc" id="L582" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_FILENAME, Settings.KEYS.ANALYZER_FILE_NAME_ENABLED));</span>
<span class="fc" id="L583">        settings.setBoolean(Settings.KEYS.ANALYZER_MIX_AUDIT_ENABLED,</span>
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_MIX_AUDIT, Settings.KEYS.ANALYZER_MIX_AUDIT_ENABLED));</span>
<span class="fc" id="L585">        settings.setBoolean(Settings.KEYS.ANALYZER_OPENSSL_ENABLED,</span>
<span class="fc bfc" id="L586" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_OPENSSL, Settings.KEYS.ANALYZER_OPENSSL_ENABLED));</span>
<span class="fc" id="L587">        settings.setBoolean(Settings.KEYS.ANALYZER_COMPOSER_LOCK_ENABLED,</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_COMPOSER, Settings.KEYS.ANALYZER_COMPOSER_LOCK_ENABLED));</span>
<span class="fc" id="L589">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_COMPOSER_LOCK_SKIP_DEV,</span>
<span class="fc" id="L590">                cli.hasOption(CliParser.ARGUMENT.COMPOSER_LOCK_SKIP_DEV));</span>
<span class="fc" id="L591">        settings.setBoolean(Settings.KEYS.ANALYZER_CPANFILE_ENABLED,</span>
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_CPAN, Settings.KEYS.ANALYZER_CPANFILE_ENABLED));</span>
<span class="fc" id="L593">        settings.setBoolean(Settings.KEYS.ANALYZER_GOLANG_DEP_ENABLED,</span>
<span class="pc bpc" id="L594" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_GO_DEP, Settings.KEYS.ANALYZER_GOLANG_DEP_ENABLED));</span>
<span class="fc" id="L595">        settings.setBoolean(Settings.KEYS.ANALYZER_GOLANG_MOD_ENABLED,</span>
<span class="pc bpc" id="L596" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_GOLANG_MOD, Settings.KEYS.ANALYZER_GOLANG_MOD_ENABLED));</span>
<span class="fc" id="L597">        settings.setBoolean(Settings.KEYS.ANALYZER_DART_ENABLED,</span>
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_DART, Settings.KEYS.ANALYZER_DART_ENABLED));</span>
<span class="fc" id="L599">        settings.setBoolean(Settings.KEYS.ANALYZER_NODE_PACKAGE_ENABLED,</span>
<span class="fc bfc" id="L600" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_NODE_JS, Settings.KEYS.ANALYZER_NODE_PACKAGE_ENABLED));</span>
<span class="fc" id="L601">        settings.setBoolean(Settings.KEYS.ANALYZER_NODE_AUDIT_ENABLED,</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">                !cli.isNodeAuditDisabled());</span>
<span class="fc" id="L603">        settings.setBoolean(Settings.KEYS.ANALYZER_YARN_AUDIT_ENABLED,</span>
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">                !cli.isYarnAuditDisabled());</span>
<span class="fc" id="L605">        settings.setBoolean(Settings.KEYS.ANALYZER_PNPM_AUDIT_ENABLED,</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">                !cli.isPnpmAuditDisabled());</span>
<span class="fc" id="L607">        settings.setBoolean(Settings.KEYS.ANALYZER_NODE_AUDIT_USE_CACHE,</span>
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_NODE_AUDIT_CACHE, Settings.KEYS.ANALYZER_NODE_AUDIT_USE_CACHE));</span>
<span class="fc" id="L609">        settings.setBoolean(Settings.KEYS.ANALYZER_RETIREJS_ENABLED,</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_RETIRE_JS, Settings.KEYS.ANALYZER_RETIREJS_ENABLED));</span>
<span class="fc" id="L611">        settings.setBoolean(Settings.KEYS.ANALYZER_SWIFT_PACKAGE_MANAGER_ENABLED,</span>
<span class="fc bfc" id="L612" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_SWIFT, Settings.KEYS.ANALYZER_SWIFT_PACKAGE_MANAGER_ENABLED));</span>
<span class="fc" id="L613">        settings.setBoolean(Settings.KEYS.ANALYZER_SWIFT_PACKAGE_RESOLVED_ENABLED,</span>
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_SWIFT_RESOLVED, Settings.KEYS.ANALYZER_SWIFT_PACKAGE_RESOLVED_ENABLED));</span>
<span class="fc" id="L615">        settings.setBoolean(Settings.KEYS.ANALYZER_COCOAPODS_ENABLED,</span>
<span class="fc bfc" id="L616" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_COCOAPODS, Settings.KEYS.ANALYZER_COCOAPODS_ENABLED));</span>
<span class="fc" id="L617">        settings.setBoolean(Settings.KEYS.ANALYZER_CARTHAGE_ENABLED,</span>
<span class="fc bfc" id="L618" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_CARTHAGE, Settings.KEYS.ANALYZER_CARTHAGE_ENABLED));</span>
<span class="fc" id="L619">        settings.setBoolean(Settings.KEYS.ANALYZER_RUBY_GEMSPEC_ENABLED,</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_RUBYGEMS, Settings.KEYS.ANALYZER_RUBY_GEMSPEC_ENABLED));</span>
<span class="fc" id="L621">        settings.setBoolean(Settings.KEYS.ANALYZER_CENTRAL_ENABLED,</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_CENTRAL, Settings.KEYS.ANALYZER_CENTRAL_ENABLED));</span>
<span class="fc" id="L623">        settings.setBoolean(Settings.KEYS.ANALYZER_CENTRAL_USE_CACHE,</span>
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_CENTRAL_CACHE, Settings.KEYS.ANALYZER_CENTRAL_USE_CACHE));</span>
<span class="fc" id="L625">        settings.setBoolean(Settings.KEYS.ANALYZER_OSSINDEX_ENABLED,</span>
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_OSSINDEX, Settings.KEYS.ANALYZER_OSSINDEX_ENABLED));</span>
<span class="fc" id="L627">        settings.setBoolean(Settings.KEYS.ANALYZER_OSSINDEX_USE_CACHE,</span>
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_OSSINDEX_CACHE, Settings.KEYS.ANALYZER_OSSINDEX_USE_CACHE));</span>

<span class="fc" id="L630">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_NODE_PACKAGE_SKIPDEV,</span>
<span class="fc" id="L631">                cli.hasOption(CliParser.ARGUMENT.NODE_PACKAGE_SKIP_DEV_DEPENDENCIES));</span>
<span class="fc" id="L632">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_NODE_AUDIT_SKIPDEV,</span>
<span class="fc" id="L633">                cli.hasOption(CliParser.ARGUMENT.DISABLE_NODE_AUDIT_SKIPDEV));</span>
<span class="fc" id="L634">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_NEXUS_ENABLED,</span>
<span class="fc" id="L635">                cli.hasOption(CliParser.ARGUMENT.ENABLE_NEXUS));</span>
<span class="fc" id="L636">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_CENTRAL_URL,</span>
<span class="fc" id="L637">                cli.getStringArgument(CliParser.ARGUMENT.CENTRAL_URL));</span>
<span class="fc" id="L638">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_CENTRAL_USER,</span>
<span class="fc" id="L639">                cli.getStringArgument(CliParser.ARGUMENT.CENTRAL_USERNAME));</span>
<span class="fc" id="L640">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_CENTRAL_PASSWORD,</span>
<span class="fc" id="L641">                cli.getStringArgument(CliParser.ARGUMENT.CENTRAL_PASSWORD));</span>
<span class="fc" id="L642">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_CENTRAL_BEARER_TOKEN,</span>
<span class="fc" id="L643">                cli.getStringArgument(CliParser.ARGUMENT.CENTRAL_BEARER_TOKEN));</span>
<span class="fc" id="L644">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_OSSINDEX_URL,</span>
<span class="fc" id="L645">                cli.getStringArgument(CliParser.ARGUMENT.OSSINDEX_URL));</span>
<span class="fc" id="L646">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_OSSINDEX_USER,</span>
<span class="fc" id="L647">                cli.getStringArgument(CliParser.ARGUMENT.OSSINDEX_USERNAME));</span>
<span class="fc" id="L648">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_OSSINDEX_PASSWORD,</span>
<span class="fc" id="L649">                cli.getStringArgument(CliParser.ARGUMENT.OSSINDEX_PASSWORD, Settings.KEYS.ANALYZER_OSSINDEX_PASSWORD));</span>
<span class="fc" id="L650">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_OSSINDEX_WARN_ONLY_ON_REMOTE_ERRORS,</span>
<span class="fc" id="L651">                cli.getStringArgument(CliParser.ARGUMENT.OSSINDEX_WARN_ONLY_ON_REMOTE_ERRORS,</span>
                        Settings.KEYS.ANALYZER_OSSINDEX_WARN_ONLY_ON_REMOTE_ERRORS));
<span class="fc" id="L653">        settings.setFloat(Settings.KEYS.JUNIT_FAIL_ON_CVSS,</span>
<span class="fc" id="L654">                cli.getFloatArgument(CliParser.ARGUMENT.FAIL_JUNIT_ON_CVSS, 0));</span>
<span class="fc" id="L655">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_ARTIFACTORY_ENABLED,</span>
<span class="fc" id="L656">                cli.hasOption(CliParser.ARGUMENT.ARTIFACTORY_ENABLED));</span>
<span class="fc" id="L657">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_ARTIFACTORY_PARALLEL_ANALYSIS,</span>
<span class="fc" id="L658">                cli.getBooleanArgument(CliParser.ARGUMENT.ARTIFACTORY_PARALLEL_ANALYSIS));</span>
<span class="fc" id="L659">        settings.setBooleanIfNotNull(Settings.KEYS.ANALYZER_ARTIFACTORY_USES_PROXY,</span>
<span class="fc" id="L660">                cli.getBooleanArgument(CliParser.ARGUMENT.ARTIFACTORY_USES_PROXY));</span>
<span class="fc" id="L661">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_ARTIFACTORY_URL,</span>
<span class="fc" id="L662">                cli.getStringArgument(CliParser.ARGUMENT.ARTIFACTORY_URL));</span>
<span class="fc" id="L663">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_ARTIFACTORY_API_USERNAME,</span>
<span class="fc" id="L664">                cli.getStringArgument(CliParser.ARGUMENT.ARTIFACTORY_USERNAME));</span>
<span class="fc" id="L665">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_ARTIFACTORY_API_TOKEN,</span>
<span class="fc" id="L666">                cli.getStringArgument(CliParser.ARGUMENT.ARTIFACTORY_API_TOKEN));</span>
<span class="fc" id="L667">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_ARTIFACTORY_BEARER_TOKEN,</span>
<span class="fc" id="L668">                cli.getStringArgument(CliParser.ARGUMENT.ARTIFACTORY_BEARER_TOKEN));</span>
<span class="fc" id="L669">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_MIX_AUDIT_PATH,</span>
<span class="fc" id="L670">                cli.getStringArgument(CliParser.ARGUMENT.PATH_TO_MIX_AUDIT));</span>
<span class="fc" id="L671">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_BUNDLE_AUDIT_PATH,</span>
<span class="fc" id="L672">                cli.getStringArgument(CliParser.ARGUMENT.PATH_TO_BUNDLE_AUDIT));</span>
<span class="fc" id="L673">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_BUNDLE_AUDIT_WORKING_DIRECTORY,</span>
<span class="fc" id="L674">                cli.getStringArgument(CliParser.ARGUMENT.PATH_TO_BUNDLE_AUDIT_WORKING_DIRECTORY));</span>
<span class="fc" id="L675">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_NEXUS_URL,</span>
<span class="fc" id="L676">                cli.getStringArgument(CliParser.ARGUMENT.NEXUS_URL));</span>
<span class="fc" id="L677">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_NEXUS_USER,</span>
<span class="fc" id="L678">                cli.getStringArgument(CliParser.ARGUMENT.NEXUS_USERNAME));</span>
<span class="fc" id="L679">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_NEXUS_PASSWORD,</span>
<span class="fc" id="L680">                cli.getStringArgument(CliParser.ARGUMENT.NEXUS_PASSWORD, Settings.KEYS.ANALYZER_NEXUS_PASSWORD));</span>
        //TODO deprecate this in favor of non-proxy host
<span class="fc" id="L682">        final boolean nexusUsesProxy = cli.isNexusUsesProxy();</span>
<span class="fc" id="L683">        settings.setBoolean(Settings.KEYS.ANALYZER_NEXUS_USES_PROXY, nexusUsesProxy);</span>
<span class="fc" id="L684">        settings.setStringIfNotEmpty(Settings.KEYS.DB_DRIVER_NAME,</span>
<span class="fc" id="L685">                cli.getStringArgument(CliParser.ARGUMENT.DB_DRIVER));</span>
<span class="fc" id="L686">        settings.setStringIfNotEmpty(Settings.KEYS.DB_DRIVER_PATH,</span>
<span class="fc" id="L687">                cli.getStringArgument(CliParser.ARGUMENT.DB_DRIVER_PATH));</span>
<span class="fc" id="L688">        settings.setStringIfNotEmpty(Settings.KEYS.DB_CONNECTION_STRING,</span>
<span class="fc" id="L689">                cli.getStringArgument(CliParser.ARGUMENT.CONNECTION_STRING));</span>
<span class="fc" id="L690">        settings.setStringIfNotEmpty(Settings.KEYS.DB_USER,</span>
<span class="fc" id="L691">                cli.getStringArgument(CliParser.ARGUMENT.DB_NAME));</span>
<span class="fc" id="L692">        settings.setStringIfNotEmpty(Settings.KEYS.DB_PASSWORD,</span>
<span class="fc" id="L693">                cli.getStringArgument(CliParser.ARGUMENT.DB_PASSWORD, Settings.KEYS.DB_PASSWORD));</span>
<span class="fc" id="L694">        settings.setStringIfNotEmpty(Settings.KEYS.ADDITIONAL_ZIP_EXTENSIONS,</span>
<span class="fc" id="L695">                cli.getStringArgument(CliParser.ARGUMENT.ADDITIONAL_ZIP_EXTENSIONS));</span>
<span class="fc" id="L696">        settings.setStringIfNotEmpty(Settings.KEYS.ANALYZER_ASSEMBLY_DOTNET_PATH,</span>
<span class="fc" id="L697">                cli.getStringArgument(CliParser.ARGUMENT.PATH_TO_CORE));</span>

<span class="fc" id="L699">        String key = cli.getStringArgument(CliParser.ARGUMENT.NVD_API_KEY);</span>
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">        if (key != null) {</span>
<span class="nc bnc" id="L701" title="All 8 branches missed.">            if ((key.startsWith(&quot;\&quot;&quot;) &amp;&amp; key.endsWith(&quot;\&quot;&quot;) || (key.startsWith(&quot;'&quot;) &amp;&amp; key.endsWith(&quot;'&quot;)))) {</span>
<span class="nc" id="L702">                key = key.substring(1, key.length() - 1);</span>
            }
<span class="nc" id="L704">            settings.setStringIfNotEmpty(Settings.KEYS.NVD_API_KEY, key);</span>
        }
<span class="fc" id="L706">        settings.setStringIfNotEmpty(Settings.KEYS.NVD_API_ENDPOINT,</span>
<span class="fc" id="L707">                cli.getStringArgument(CliParser.ARGUMENT.NVD_API_ENDPOINT));</span>
<span class="fc" id="L708">        settings.setIntIfNotNull(Settings.KEYS.NVD_API_DELAY, cli.getIntegerValue(CliParser.ARGUMENT.NVD_API_DELAY));</span>
<span class="fc" id="L709">        settings.setIntIfNotNull(Settings.KEYS.NVD_API_RESULTS_PER_PAGE, cli.getIntegerValue(CliParser.ARGUMENT.NVD_API_RESULTS_PER_PAGE));</span>
<span class="fc" id="L710">        settings.setStringIfNotEmpty(Settings.KEYS.NVD_API_DATAFEED_URL, cli.getStringArgument(CliParser.ARGUMENT.NVD_API_DATAFEED_URL));</span>
<span class="fc" id="L711">        settings.setStringIfNotEmpty(Settings.KEYS.NVD_API_DATAFEED_USER, cli.getStringArgument(CliParser.ARGUMENT.NVD_API_DATAFEED_USER));</span>
<span class="fc" id="L712">        settings.setStringIfNotEmpty(Settings.KEYS.NVD_API_DATAFEED_PASSWORD, cli.getStringArgument(CliParser.ARGUMENT.NVD_API_DATAFEED_PASSWORD));</span>
<span class="fc" id="L713">        settings.setStringIfNotEmpty(Settings.KEYS.NVD_API_DATAFEED_BEARER_TOKEN, cli.getStringArgument(CliParser.ARGUMENT.NVD_API_DATAFEED_BEARER_TOKEN));</span>
<span class="fc" id="L714">        settings.setIntIfNotNull(Settings.KEYS.NVD_API_MAX_RETRY_COUNT, cli.getIntegerValue(CliParser.ARGUMENT.NVD_API_MAX_RETRY_COUNT));</span>
<span class="fc" id="L715">        settings.setIntIfNotNull(Settings.KEYS.NVD_API_VALID_FOR_HOURS, cli.getIntegerValue(CliParser.ARGUMENT.NVD_API_VALID_FOR_HOURS));</span>

<span class="fc" id="L717">        settings.setStringIfNotNull(Settings.KEYS.HOSTED_SUPPRESSIONS_URL,</span>
<span class="fc" id="L718">                cli.getStringArgument(CliParser.ARGUMENT.HOSTED_SUPPRESSIONS_URL));</span>
<span class="fc" id="L719">        settings.setStringIfNotNull(Settings.KEYS.HOSTED_SUPPRESSIONS_USER,</span>
<span class="fc" id="L720">                cli.getStringArgument(CliParser.ARGUMENT.HOSTED_SUPPRESSIONS_USER));</span>
<span class="fc" id="L721">        settings.setStringIfNotNull(Settings.KEYS.HOSTED_SUPPRESSIONS_PASSWORD,</span>
<span class="fc" id="L722">                cli.getStringArgument(CliParser.ARGUMENT.HOSTED_SUPPRESSIONS_PASSWORD));</span>
<span class="fc" id="L723">        settings.setStringIfNotNull(Settings.KEYS.HOSTED_SUPPRESSIONS_BEARER_TOKEN,</span>
<span class="fc" id="L724">                cli.getStringArgument(CliParser.ARGUMENT.HOSTED_SUPPRESSIONS_BEARER_TOKEN));</span>
<span class="fc" id="L725">        settings.setBoolean(Settings.KEYS.HOSTED_SUPPRESSIONS_ENABLED,</span>
<span class="pc bpc" id="L726" title="1 of 2 branches missed.">                !cli.isDisabled(CliParser.ARGUMENT.DISABLE_HOSTED_SUPPRESSIONS, Settings.KEYS.HOSTED_SUPPRESSIONS_ENABLED));</span>
<span class="fc" id="L727">        settings.setBooleanIfNotNull(Settings.KEYS.HOSTED_SUPPRESSIONS_FORCEUPDATE,</span>
<span class="fc" id="L728">                cli.hasOption(CliParser.ARGUMENT.HOSTED_SUPPRESSIONS_FORCEUPDATE));</span>
<span class="fc" id="L729">        settings.setIntIfNotNull(Settings.KEYS.HOSTED_SUPPRESSIONS_VALID_FOR_HOURS,</span>
<span class="fc" id="L730">                cli.getIntegerValue(CliParser.ARGUMENT.HOSTED_SUPPRESSIONS_VALID_FOR_HOURS));</span>
<span class="fc" id="L731">    }</span>

    //CSON: MethodLength
    /**
     * Creates a file appender and adds it to logback.
     *
     * @param verboseLog the path to the verbose log file
     */
    private void prepareLogger(String verboseLog) {
<span class="nc" id="L740">        final LoggerContext context = (LoggerContext) LoggerFactory.getILoggerFactory();</span>
<span class="nc" id="L741">        final PatternLayoutEncoder encoder = new PatternLayoutEncoder();</span>
<span class="nc" id="L742">        encoder.setPattern(&quot;%d %C:%L%n%-5level - %msg%n&quot;);</span>
<span class="nc" id="L743">        encoder.setContext(context);</span>
<span class="nc" id="L744">        encoder.start();</span>
<span class="nc" id="L745">        final FileAppender&lt;ILoggingEvent&gt; fa = new FileAppender&lt;&gt;();</span>
<span class="nc" id="L746">        fa.setAppend(true);</span>
<span class="nc" id="L747">        fa.setEncoder(encoder);</span>
<span class="nc" id="L748">        fa.setContext(context);</span>
<span class="nc" id="L749">        fa.setFile(verboseLog);</span>
<span class="nc" id="L750">        final File f = new File(verboseLog);</span>
<span class="nc" id="L751">        String name = f.getName();</span>
<span class="nc" id="L752">        final int i = name.lastIndexOf('.');</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">        if (i &gt; 1) {</span>
<span class="nc" id="L754">            name = name.substring(0, i);</span>
        }
<span class="nc" id="L756">        fa.setName(name);</span>
<span class="nc" id="L757">        fa.start();</span>
<span class="nc" id="L758">        final ch.qos.logback.classic.Logger rootLogger = context.getLogger(ch.qos.logback.classic.Logger.ROOT_LOGGER_NAME);</span>
<span class="nc" id="L759">        rootLogger.setLevel(Level.DEBUG);</span>
<span class="nc" id="L760">        final ThresholdFilter filter = new ThresholdFilter();</span>
<span class="nc" id="L761">        filter.setLevel(LogLevel.INFO.getValue());</span>
<span class="nc" id="L762">        filter.setContext(context);</span>
<span class="nc" id="L763">        filter.start();</span>
<span class="nc" id="L764">        rootLogger.iteratorForAppenders().forEachRemaining(action -&gt; action.addFilter(filter));</span>
<span class="nc" id="L765">        rootLogger.addAppender(fa);</span>
<span class="nc" id="L766">    }</span>

    /**
     * Takes a path and resolves it to be a canonical &amp;amp; absolute path. The
     * caveats are that this method will take an Ant style file selector path
     * (../someDir/**\/*.jar) and convert it to an absolute/canonical path (at
     * least to the left of the first * or ?).
     *
     * @param path the path to canonicalize
     * @return the canonical path
     */
    protected String ensureCanonicalPath(String path) {
        final String basePath;
<span class="fc" id="L779">        String wildCards = null;</span>
<span class="fc" id="L780">        final String file = path.replace('\\', '/');</span>
<span class="pc bpc" id="L781" title="1 of 4 branches missed.">        if (file.contains(&quot;*&quot;) || file.contains(&quot;?&quot;)) {</span>

<span class="fc" id="L783">            int pos = getLastFileSeparator(file);</span>
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">            if (pos &lt; 0) {</span>
<span class="nc" id="L785">                return file;</span>
            }
<span class="fc" id="L787">            pos += 1;</span>
<span class="fc" id="L788">            basePath = file.substring(0, pos);</span>
<span class="fc" id="L789">            wildCards = file.substring(pos);</span>
<span class="fc" id="L790">        } else {</span>
<span class="fc" id="L791">            basePath = file;</span>
        }

<span class="fc" id="L794">        File f = new File(basePath);</span>
        try {
<span class="fc" id="L796">            f = f.getCanonicalFile();</span>
<span class="fc bfc" id="L797" title="All 2 branches covered.">            if (wildCards != null) {</span>
<span class="fc" id="L798">                f = new File(f, wildCards);</span>
            }
<span class="nc" id="L800">        } catch (IOException ex) {</span>
<span class="nc" id="L801">            LOGGER.warn(&quot;Invalid path '{}' was provided.&quot;, path);</span>
<span class="nc" id="L802">            LOGGER.debug(&quot;Invalid path provided&quot;, ex);</span>
<span class="fc" id="L803">        }</span>
<span class="fc" id="L804">        return f.getAbsolutePath().replace('\\', '/');</span>
    }

    /**
     * Returns the position of the last file separator.
     *
     * @param file a file path
     * @return the position of the last file separator
     */
    @SuppressWarnings(&quot;ManualMinMaxCalculation&quot;)
    private int getLastFileSeparator(String file) {
<span class="pc bpc" id="L815" title="3 of 4 branches missed.">        if (file.contains(&quot;*&quot;) || file.contains(&quot;?&quot;)) {</span>
<span class="fc" id="L816">            int p1 = file.indexOf('*');</span>
<span class="fc" id="L817">            int p2 = file.indexOf('?');</span>
<span class="pc bpc" id="L818" title="1 of 2 branches missed.">            p1 = p1 &gt; 0 ? p1 : file.length();</span>
<span class="pc bpc" id="L819" title="1 of 2 branches missed.">            p2 = p2 &gt; 0 ? p2 : file.length();</span>
<span class="pc bpc" id="L820" title="1 of 2 branches missed.">            int pos = p1 &lt; p2 ? p1 : p2;</span>
<span class="fc" id="L821">            pos = file.lastIndexOf('/', pos);</span>
<span class="fc" id="L822">            return pos;</span>
        } else {
<span class="nc" id="L824">            return file.lastIndexOf('/');</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>